
stages:
  - test
  - build
  - deploy

include:
  - template: Security/SAST.gitlab-ci.yml

azure-auth:
  image: mcr.microsoft.com/azure-cli:latest
  stage: test
  variables:
    AZURE_CLIENT_ID: $AAD_GITLAB_CI_CLIENT_ID
    AZURE_TENANT_ID: $AZURE_TENANT_ID_HEGERDES
  id_tokens:
    GITLAB_OIDC_TOKEN:
      aud: https://gitlab.com
  script:
    - az login --service-principal -u $AZURE_CLIENT_ID -t $AZURE_TENANT_ID --federated-token $GITLAB_OIDC_TOKEN
    - az account show

sast:
  stage: test

deploy:
  image:
    name: bitnami/kubectl:latest
    entrypoint: ['']
  variables:
    KUBE_CONTEXT: hcloud # The name to use for the new context
    AGENT_ID: 1080383 # replace with your agent's numeric ID
    K8S_PROXY_URL: https://kas.gitlab.com/k8s-proxy/ # For agent server (KAS) deployed in Kubernetes cluster (for gitlab.com use kas.gitlab.com); replace with your URL
    # K8S_PROXY_URL: https://<GITLAB_DOMAIN>/-/kubernetes-agent/k8s-proxy/ # For agent server (KAS) in Omnibus
    # ... any other variables you have configured
  before_script:
    - kubectl config set-credentials agent:$AGENT_ID --token="ci:${AGENT_ID}:${CI_JOB_TOKEN}"
    - kubectl config set-cluster gitlab --server="${K8S_PROXY_URL}"
    - kubectl config set-context "$KUBE_CONTEXT" --cluster=gitlab --user="agent:${AGENT_ID}"
    - kubectl config use-context "$KUBE_CONTEXT"
  script:
    - kubectl config get-contexts
    - kubectl get pods -A
    - kubectl get ns
