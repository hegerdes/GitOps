#cloud-config

ssh_pwauth: false
# disable_root: true
disable_root_opts: no-port-forwarding,no-agent-forwarding,no-X11-forwarding

groups: [cloud]

users:
  - name: bootstrap
    sudo: ALL=(ALL) NOPASSWD:ALL
    groups: users, cloud
    shell: /bin/bash
    lock_passwd: true
    ssh_authorized_keys:
%{ for key in ssh_key ~}
      - ${key}
%{ endfor ~}


# Write files
write_files:
  - content: Created by Packer
    path: /var/log/created-by.log
    append: true
  - content: |
      #!/bin/bash
      echo "Set DNS64 nameservers. The time is now $(date -R)!"
      echo "This file is generated by /var/lib/cloud/scripts/per-boot/set-dns64.sh on every boot" > /etc/resolv.conf
      echo "nameserver 1.1.1.1" >> /etc/resolv.conf
      echo "nameserver 8.8.8.8" >> /etc/resolv.conf
      # echo "nameserver 2a00:1098:2c::1" >> /etc/resolv.conf
      # echo "nameserver 2a00:1098:2b::1" >> /etc/resolv.conf
    path: /var/lib/cloud/scripts/per-boot/set-dns64.sh
    permissions: "0755"

# Install base packages
package_update: true
package_upgrade: false
package_reboot_if_required: false
packages:
  - gnupg
  - lsb-release
  - ca-certificates
  - curl
  - pigz # fast decompress for container image
  - isal # even faster decompress for container image
  - cryptsetup # support LUKS disk encryptio
  - apparmor
  - apparmor-profiles-extra
  - apt-transport-https
  - jq # json parsing and validating
  - yq # yaml parsing and validating
  - unzip
  - socat
  - mtr-tiny
  - logrotate
  - open-iscsi
  - ipvsadm
  - auditd
  - fuse
  - dbus
  - libyajl2 # Needed for youki wasm

  # Only needed on Cp nodes
  - python3-kubernetes
  - kubectl

  # SELINUX stuff
  # - policycoreutils
  # - selinux-basics
  # - selinux-policy-default
  # - semodule-utils
  # - setools

# ansible:
#   package_name: ansible
#   install_method: pip
#   pull:
#     url: "https://github.com/hegerdes/ansible-playbooks.git"
#     playbook_name: pb_k8s_local.yml

runcmd:
  - echo "10.0.0.8 k8s-controlplane.local" >> /etc/hosts
  - echo "Cloud-Init finished" >> /srv/cloud-init-msg.txt

# power_state:
#  mode: reboot
#  message: Bye Bye
#  timeout: 300
#  condition: True
