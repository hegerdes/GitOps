---
# Source: opa-kube-mgmt/templates/serviceaccount.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: open-policy-agent-0-opa-kube-mgmt
  labels:
    app: open-policy-agent-0-opa-kube-mgmt
    chart: opa-kube-mgmt-9.3.0
    release: "open-policy-agent-0"
    heritage: "Helm"
---
# Source: opa-kube-mgmt/templates/webhookconfiguration.yaml
apiVersion: v1
kind: Secret
metadata:
  name: open-policy-agent-0-opa-kube-mgmt-cert
  labels:
    app: open-policy-agent-0-opa-kube-mgmt
    chart: "opa-kube-mgmt-9.3.0"
    release: "open-policy-agent-0"
    heritage: "Helm"
type: Opaque
data:
  tls.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURlakNDQW1LZ0F3SUJBZ0lSQU1UL3V6WXplZ1VBaGczeG1mOXF2dXd3RFFZSktvWklodmNOQVFFTEJRQXcKR3pFWk1CY0dBMVVFQXhNUWIzQmhMV0ZrYldsemMybHZiaTFqWVRBZUZ3MHlOakF4TWpFeU1URTRNalphRncwegpOakF4TVRreU1URTRNalphTURneE5qQTBCZ05WQkFNVExXOXdaVzR0Y0c5c2FXTjVMV0ZuWlc1MExUQXRiM0JoCkxXdDFZbVV0YldkdGRDNWtaV1poZFd4MExuTjJZekNDQVNJd0RRWUpLb1pJaHZjTkFRRUJCUUFEZ2dFUEFEQ0MKQVFvQ2dnRUJBTHNyUXljTHhBSExObmdLT2J6WE1jNVBCY3kwcW5pTDhsWm1ha29LUVhNcjFaNUJNSTVMdWtPUgp4MnQ4Y2lhbWg0ejdYUmEvenY0UUlwemlGUTBaQWZ6Sm1aNmIxU1lRcVJkQUZMblp1TXBvRnprWTR4SVAwcjVmCjFuZUZhaDFheVg1QXRLeGxvOXRwZmRmUXNNTHhReC9UZUpYWjVoNHFVWGdUTzI2Vk1uMXRqRC9MYUwreW1KR20KZUcxVVU1OTBHSFkxUktpZGFQWWMvR2pvZkVaMDI3blh0VUhMN2RBYyt4TFFpNGNBdkhoeXhNR05ZR2ordGhHeQpRVHIxWVlXSEs2UC9xbnFGL3VEaVM0SmU1YnZRWWxUNFh3bVNvWkxuUXJiaGczc0REVFJuNmZFUWpRdTllL1FBCkJBMnN6S2pLeFlCSExUSldLd3FVbThCZ1pGTkROclVDQXdFQUFhT0JtekNCbURBT0JnTlZIUThCQWY4RUJBTUMKQmFBd0hRWURWUjBsQkJZd0ZBWUlLd1lCQlFVSEF3RUdDQ3NHQVFVRkJ3TUNNQXdHQTFVZEV3RUIvd1FDTUFBdwpId1lEVlIwakJCZ3dGb0FVWGFhZXNCTVhRV09Sb1VHNFUzYnZtT2poQTcwd09BWURWUjBSQkRFd0w0SXRiM0JsCmJpMXdiMnhwWTNrdFlXZGxiblF0TUMxdmNHRXRhM1ZpWlMxdFoyMTBMbVJsWm1GMWJIUXVjM1pqTUEwR0NTcUcKU0liM0RRRUJDd1VBQTRJQkFRQ2hHdGNwTVFlUHpCaUxKcWs1N1MrOWMxb1Z0K21nNUU0K0VPcmh3azRabytyeAo3aHJPSEpqQk5Nd2c4aEVRdnM0Rkx5bkRycm9SM3l1aTlkazJmODZMWHByZDZJdS82MlNraDZQRTJoK3MvNS9jClc0OFRiRGMvR1lnUlJMOUs0Ym53VERWR1V3ZElQUGZSMkxVM3F3QnZVb0NsKzlNeVZTOEVjazM1VkZYL2lpZ1UKL0hBZ0s4bGtpUmxzTUhCVVdPMVFwRW5ZSWUvTXp0NFRlOFBReTZ4UVUxb3ZUVmVlS0xjYTN0S3k4SU4zNXArMgpESlExSSttRG5ody90RjBUQUdoK1ByZmdqWitTMEJMTURlWDZrcUtjSUZzdFdJU04yc1J0ZGsvUUxFby9CRXNSCjZhaHNWVzFoK2l0MUV5YmNrT3dnakhsRFNQK3dtOFBiOUloYWY5WEgKLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=
  tls.key: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFcEFJQkFBS0NBUUVBdXl0REp3dkVBY3MyZUFvNXZOY3h6azhGekxTcWVJdnlWbVpxU2dwQmN5dlZua0V3CmprdTZRNUhIYTN4eUpxYUhqUHRkRnIvTy9oQWluT0lWRFJrQi9NbVpucHZWSmhDcEYwQVV1ZG00eW1nWE9SamoKRWcvU3ZsL1dkNFZxSFZySmZrQzByR1dqMjJsOTE5Q3d3dkZESDlONGxkbm1IaXBSZUJNN2JwVXlmVzJNUDh0bwp2N0tZa2FaNGJWUlRuM1FZZGpWRXFKMW85aHo4YU9oOFJuVGJ1ZGUxUWN2dDBCejdFdENMaHdDOGVITEV3WTFnCmFQNjJFYkpCT3ZWaGhZY3JvLytxZW9YKzRPSkxnbDdsdTlCaVZQaGZDWktoa3VkQ3R1R0Rld01OTkdmcDhSQ04KQzcxNzlBQUVEYXpNcU1yRmdFY3RNbFlyQ3BTYndHQmtVME0ydFFJREFRQUJBb0lCQUFDRVJoajc3OW5UTFVUMQpGY29LQnltdzF1QkNaTE5ja212YVBUOEpqeXVueUh1MGNEUzNqcVFlZUxTcGlXZnZsc3NxelFsRVIvZk41ekxnCjM1NCtaZk1nVndjNTB0THV3ZUd6eWk5V2NHa1RieUIvZ1RYRk1jL3hJUDBKOVp1Tnh5Q0tpYjlqSU94NDVoN2cKY0tZVXBBWWVCemFYZlVnUEtDcjZra3I5ZjMyQkVUbTROUU8veTFTNnJxUHFoOGwyb2JjWUN4VHVMdm14dzBFTwo4WmI3WkRxdnh1NEpHTUlXTG5iUFZrWElvMnNUSi8zdW9Ga1hkMUQ0WjJJR3hHRVBaL2Z2LzNEbkJkaXNacHpDCnFWRFltVml4dlFiOGlESFVQaG4rTWp0d0tEb0VTaE45U0ZQWlZrRmdJd2RhenZVaXVBcGUzTFdHb2w4bElJa2QKb2FacXh3RUNnWUVBNVZFcHV0UHByYWYxUXVENFRBaW1RMysyTDExNkpmN1FtcEhZS2xHWGVmVTZaOG9pallOVApIcnZKaHRGcXhJazhRQ3Y5MGx4SG8yUERvdW5ZN214RVgxUStwMWJIWjBhNnRiNkFyMEFzMTN2eG1VZS8wVnBDCmVDQlQ0Y29ZcU1hVGRwSlZHY3FNNFhKQVkvNXFMVVdwaVFXWmFadHlwYWFvdW9FRVRTNDc3RUVDZ1lFQTBQS2EKcEJQMVBDRGJzN1lPNklaT29GRTZTdCs3aU42WWFXVUV3eVhMRlpacmxib3ZhYmdTMUtlUkxLcm11N2piV3MxSgpGcEladHY0L0sxSDVhQlJxQ2FIUWZvNEJPY3NvNE8xNlEyZkhtMXNrWHpFWmEzangzWEVzSWF1NU9wVVBJRS9aCk1wb0VRR2t5QWNwd2JDL3BoUGhNUGxCeUlJOGpFRWNhbUxCay9YVUNnWUVBeFJaYXJTM1FtdVhOejJzWFBCSDcKQSt4Um9xZk9nYlZkaUZ0czFBSklGQk9GM1FwSFpDVElYWk84QXRrZDBFaTZ0ZFNaVkNEbm1TLzNScCtCU0hsWQowaTNQbzNiYjdwRkZpMHB0d3pGKzJMeTN5cXQxMnZLZVNpeE9xN0pNTzFKZ0R2cDVsYThXSWZWV0RocnRHbmZTCjIrY3FFUy8rK3d3ZjNCdGluUXJ0aVlFQ2dZRUF3bUZ2UzBUbDExSWFFVTFGQVR3dzJTTzN2di8wVHBnRjRjYUEKYjZzeENwd3M2ZFdUVmg1UUpsVGMwVmtMM1lkVFNWM0FxS2F5RlhMaEFVUDVhY0hVQTdIdGJFNWZCWXppTXAyNgpLQXJidnNORFN1czZZcWpaR05DMzVYc0RqbVFzOWpwU0xLanJXNkNCVFBrdkxQWkZuOVg5MTlxdTBXdFhpMFVhCmtRRkljaUVDZ1lCbGxvb2VROWdJS2RxdTVweXdQZU42RnZaQjkzUGlaMWtna2dHQ0hUcTZydWVUdGFPY3Jhd3QKNytYbWh0OXhjL0hMbU5aanEzTTFtTE96dmc1T1Z6VmI5VmJXOUYvdjZpUjhkQUdaZWloc3VzK0xERndTRGwzdwpJaXo4OE44UC94VWZ4L3VXcHN2djRjUWhFM0RURkY3dkFHc0pHZjJBc3lCbXBaWHp3SVAxUWc9PQotLS0tLUVORCBSU0EgUFJJVkFURSBLRVktLS0tLQo=
---
# Source: opa-kube-mgmt/templates/rbac-mgmt.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  labels:
    app: opa-kube-mgmt
    chart: opa-kube-mgmt-9.3.0
    release: open-policy-agent-0
    component: mgmt
  name: open-policy-agent-0-opa-kube-mgmt-mgmt
  namespace: default
rules:
  - apiGroups: [""]
    resources: ["configmaps"]
    verbs: ["get", "list", "watch", "update", "patch"]
---
# Source: opa-kube-mgmt/templates/rbac-mgmt.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  labels:
    app: opa-kube-mgmt
    chart: opa-kube-mgmt-9.3.0
    release: open-policy-agent-0
    component: mgmt
  name: open-policy-agent-0-opa-kube-mgmt-mgmt
  namespace: default
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: open-policy-agent-0-opa-kube-mgmt-mgmt
subjects:
  - kind: ServiceAccount
    name: open-policy-agent-0-opa-kube-mgmt
    namespace: default
---
# Source: opa-kube-mgmt/templates/service.yaml
kind: Service
apiVersion: v1
metadata:
  name: open-policy-agent-0-opa-kube-mgmt
  labels:
    app: open-policy-agent-0-opa-kube-mgmt
    chart: "opa-kube-mgmt-9.3.0"
    release: "open-policy-agent-0"
    heritage: "Helm"
spec:
  selector:
    app: open-policy-agent-0-opa-kube-mgmt
  ports:
  - name: opa
    port: 8181
    targetPort: opa
---
# Source: opa-kube-mgmt/templates/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: open-policy-agent-0-opa-kube-mgmt
  labels:
    app: open-policy-agent-0-opa-kube-mgmt
    chart: "opa-kube-mgmt-9.3.0"
    release: "open-policy-agent-0"
    heritage: "Helm"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: open-policy-agent-0-opa-kube-mgmt
  template:
    metadata:
      annotations:
      labels:
        app: open-policy-agent-0-opa-kube-mgmt
      name: open-policy-agent-0-opa-kube-mgmt
    spec:
      initContainers:
        - name: initpolicy
          image: openpolicyagent/kube-mgmt:9.3.0
          imagePullPolicy: IfNotPresent
          resources:
            {}
          command:
          - /bin/sh
          - -c
          - |
            tr -dc 'A-F0-9' < /dev/urandom | dd bs=1 count=32 2>/dev/null > /bootstrap/mgmt-token
            TOKEN=`cat /bootstrap/mgmt-token`
            cat > /bootstrap/authz.rego <<EOF
            package system.authz
            import rego.v1
            default allow := false
            # Allow anonymous access to the default policy decision.
            allow if { input.path = [""]; input.method == "POST" }
            allow if { input.path = [""]; input.method == "GET" }
            # This is only used for health check in liveness and readiness probe
            allow if { input.path = ["health"]; input.method == "GET" }
            allow if { input.identity == "$TOKEN" }
            EOF
          volumeMounts:
            - name: bootstrap
              mountPath: /bootstrap
      containers:
        - name: opa
          ports:
          - name: opa
            containerPort: 8181
          image: "openpolicyagent/opa:1.3.0"
          imagePullPolicy: IfNotPresent
          env:
          resources:
            {}
          args:
            - "run"
            - "--server"
            - "--tls-cert-file=/certs/tls.crt"
            - "--tls-private-key-file=/certs/tls.key"
            - "--addr=0.0.0.0:8181"
            - "--log-level=info"
            - "--log-format=json"
            - "--authentication=token"
            - "--authorization=basic"
            - "--ignore=.*"
            - "/bootstrap"
          volumeMounts:
            - name: certs
              readOnly: true
              mountPath: /certs
            - name: bootstrap
              readOnly: true
              mountPath: /bootstrap
          readinessProbe:
            httpGet:
              path: /health
              scheme: HTTPS
              port: opa
            initialDelaySeconds: 5
            periodSeconds: 10
          livenessProbe:
            httpGet:
              path: /health
              scheme: HTTPS
              port: opa
            initialDelaySeconds: 10
            periodSeconds: 15
        - name: mgmt
          image: openpolicyagent/kube-mgmt:9.3.0
          imagePullPolicy: IfNotPresent
          startupProbe:

            failureThreshold: 5
            httpGet:
              path: /health
              port: 8181
              scheme: HTTPS
            initialDelaySeconds: 20
            successThreshold: 1
            timeoutSeconds: 10
          env:
          resources:
            
            {}
          args:
            - --opa-auth-token-file=/bootstrap/mgmt-token
            - --opa-url=https://127.0.0.1:8181/v1
            - --opa-allow-insecure
            - "--namespaces=default"
            - "--enable-data=true"
            - "--enable-policies=true"

            - "--replicate-path=kubernetes"
            - "--replicate-ignore-namespaces="
          volumeMounts:
            - name: bootstrap
              readOnly: true
              mountPath: /bootstrap
      serviceAccountName: open-policy-agent-0-opa-kube-mgmt
      volumes:
        - name: certs
          secret:
            secretName: open-policy-agent-0-opa-kube-mgmt-cert
        - name: bootstrap
          emptyDir: {}
      affinity:
        {}
      nodeSelector:
        kubernetes.io/arch: amd64
      tolerations:
        []
      topologySpreadConstraints:
        []
