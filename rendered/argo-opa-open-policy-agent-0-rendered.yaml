---
# Source: opa-kube-mgmt/templates/serviceaccount.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: open-policy-agent-0-opa-kube-mgmt
  labels:
    app: open-policy-agent-0-opa-kube-mgmt
    chart: opa-kube-mgmt-9.3.0
    release: "open-policy-agent-0"
    heritage: "Helm"
---
# Source: opa-kube-mgmt/templates/webhookconfiguration.yaml
apiVersion: v1
kind: Secret
metadata:
  name: open-policy-agent-0-opa-kube-mgmt-cert
  labels:
    app: open-policy-agent-0-opa-kube-mgmt
    chart: "opa-kube-mgmt-9.3.0"
    release: "open-policy-agent-0"
    heritage: "Helm"
type: Opaque
data:
  tls.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURlakNDQW1LZ0F3SUJBZ0lSQUw4c2FkcjBHd0lPWW1selVOZVNhT3d3RFFZSktvWklodmNOQVFFTEJRQXcKR3pFWk1CY0dBMVVFQXhNUWIzQmhMV0ZrYldsemMybHZiaTFqWVRBZUZ3MHlOakF4TWpFeU1URXdORFZhRncwegpOakF4TVRreU1URXdORFZhTURneE5qQTBCZ05WQkFNVExXOXdaVzR0Y0c5c2FXTjVMV0ZuWlc1MExUQXRiM0JoCkxXdDFZbVV0YldkdGRDNWtaV1poZFd4MExuTjJZekNDQVNJd0RRWUpLb1pJaHZjTkFRRUJCUUFEZ2dFUEFEQ0MKQVFvQ2dnRUJBSjZtQ01CUEpnQ3p0M2U4S3VPVkIrd2NuenlxRlM1MFRVVjRnUHNtT3hSblAzS283b3FMTVhkSQpDYTZsQkw5cFdyM1NGcnB3RjB6RG9ibG9pNVVIUGwranhzcWNvR1dOMVZ3cUlmdVhqemEwYjRIcTEycmFoRE5OClplNHZNZU9FM05HekdHd25oODd0cU5WcmQ2SnZIcW83ajJRMzMvMm5rNzY3REdjajIzQUFVeUhoSitWSUJpNW8KNjVXOGNmM2dONmFFWjcyOEszaUs0cHE1eFR0RlMrMTBVcC9kWmhwOWRlam5WeEY0dUtDNER2WldVSW9wU2FjOQpqTGk0QmNhcnk3blN4bzZJanlibWVQMGo4NnlveTFlM1Nwbk5RTFRuekNydGduWE95ZG5mREtxLzBPRi9pZTVsCmhINFZSM055b3dmU3ZFTWNwNEZQRDI4MkE3OU5rSXNDQXdFQUFhT0JtekNCbURBT0JnTlZIUThCQWY4RUJBTUMKQmFBd0hRWURWUjBsQkJZd0ZBWUlLd1lCQlFVSEF3RUdDQ3NHQVFVRkJ3TUNNQXdHQTFVZEV3RUIvd1FDTUFBdwpId1lEVlIwakJCZ3dGb0FVdVJVMWdIbDhPV1FrazY3c0VBOXpUNFJOSFBVd09BWURWUjBSQkRFd0w0SXRiM0JsCmJpMXdiMnhwWTNrdFlXZGxiblF0TUMxdmNHRXRhM1ZpWlMxdFoyMTBMbVJsWm1GMWJIUXVjM1pqTUEwR0NTcUcKU0liM0RRRUJDd1VBQTRJQkFRQmNKU1Jva0FDT2Vtdlc2TGhyYmRMWXhnZTdaV21mekFSaFdpeW9xcXd4WkFkLwp1TW1wWjNYWE5tQ1cvRkNoSDNRT0svdHRzc3VNaUlVSnkvaVVWWkRJbTU4OHhNUThBcXQyVTQyRVZaL2xqWGU3Ck5MUUhoZTJlREJWOTlubkx5Ymt1elFoczRGcWFvWmhvbWxZSDVXV01Zck5DQW9XYlMyL3VoMzF4eFNKZHBrckUKVE9KMDhXUXBISURZc3NvYzZpSDBXSHptaFJIcWkrcmQxc0M1anZ6Zm1mQXQva0l4S3RZN2tHaXpZWEhmSTBpQgpqT0JHZXd6aUI5NGZXVlNlVGhxZ1hIQkJaSXFIUExuNXJiOGNubHRrcHFROGVFM1JoSk1xMmkvYlh2OGI5QUxkCnI1d09XS3ZZaXNmeUEwYTdNdGs3YVNyYzA0RWtxK3RFNjdJSnN6blQKLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=
  tls.key: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFb3dJQkFBS0NBUUVBbnFZSXdFOG1BTE8zZDd3cTQ1VUg3QnlmUEtvVkxuUk5SWGlBK3lZN0ZHYy9jcWp1Cmlvc3hkMGdKcnFVRXYybGF2ZElXdW5BWFRNT2h1V2lMbFFjK1g2UEd5cHlnWlkzVlhDb2grNWVQTnJSdmdlclgKYXRxRU0wMWw3aTh4NDRUYzBiTVliQ2VIenUybzFXdDNvbThlcWp1UFpEZmYvYWVUdnJzTVp5UGJjQUJUSWVFbgo1VWdHTG1qcmxieHgvZUEzcG9SbnZid3JlSXJpbXJuRk8wVkw3WFJTbjkxbUduMTE2T2RYRVhpNG9MZ085bFpRCmlpbEpwejJNdUxnRnhxdkx1ZExHam9pUEp1WjQvU1B6cktqTFY3ZEttYzFBdE9mTUt1MkNkYzdKMmQ4TXFyL1EKNFgrSjdtV0VmaFZIYzNLakI5SzhReHluZ1U4UGJ6WUR2MDJRaXdJREFRQUJBb0lCQUNxMHBBOXNYdHo2ZzYwaQpCR09OeHZ1cWVyemdSZUppNFRnTnA1NnpuRnl5TEZTbm44ckFqRmpCRmdZaW1xUVI3cURCVUdmd2EzMDQvaXhFCk5hcXdyL3did0pQaTFKUnh1UmpkcUpjcXBaMEN0aStCTVdxc2xzQ2VtWTBqdkNpMEo2TDFOR0pNdzlTU2lndWwKS2FlYWhPVXJNajYyZ2Irc24rdE1PNXI1L29SbnpXajdudVR2NUZJUjVDWitXdFF6cS92K1hZU2VKd3Bud21KVwp1L1dRKzdYMVdzNWpla3pmbDBOa0d0bVd2MCsxMlZzenRha01nNzM3QjNMZkJwSzNraXZ4RDB5MGYycnJ5Q3RjCnFZMmNBbTU5L0hoZnhCVEhNcTVMak1ieXVCb0hSQTQxd2ZWNWRHMVFrUDUwWnZKM2VONjg4VXlyNS80ZEhWNFEKSXlFMmpta0NnWUVBd3JjN20xY1ZKamlYR2JIYnBSeVpEdHNTQ290cGxLeGJhL1FVeEJPUVJkcW5FeE1NSTRlMgpNZHNQTXp3Qm5jaENhOXlPRURUNWUzdS9pTUpoR3JaWGhkelJ3MEJLVUlJWHliNzU0dHlETC9HWlJ1MXczSDQ2CndtYmhEY2tXNnl4RnBWYWhzRmgyRUFlcnZTTUhkMWtrOUxxSWRqemVTMHBMeXN3eDVyYXBrM2tDZ1lFQTBKVEYKdU9US1Z1TThJaDRBdUdrNzFuL0QrM3BubXpWTEQwVi9VbDdCbjJvZlJzUVFtVThtZkpGLzJhQzVCZ3RYUWNJeQozZ3RkazZyNzZuOFozc2lrUHZhSWVxUm9GQzJGcDhvS1k0MWRnczlBbWpqZXFxL1B5d3hnWnZnR1BLK0NadS9uCjRiTENFVnZBYlhyaXlBQUlNamgwYUFlaU9XTTc5TitJL1hIbzN5TUNnWUFVYTVUenVKRStQZWNTeWNWSUxwU2EKcXp6Y0lEekZXOElHczBWT1B1TDlnRzNQSVVzL21xYnYyWkpoaENTRFFKSStyNVd5ZTJ2Q21IckF3K25kSEV4WApmSTMvRlFuMklYNlBLTmthQXBnN2VmSGlMMXFMdFMxQ1gvbXdNV3VXNUVDMWt6MUh1aTgvaFI1c3FuVEkvbTlTCnZ4RTZuUzJPNWM3SENOMGUzZjh3dVFLQmdRQ0RVb2ZDUjFvVnBtLy8wd0FGRzB4dlduWGI2VTg5NnluYzdaYWkKRjhLMFNhNXpjWkk1MUJtWktFcGtqTXF4UVlhb2drcGdmcXRtQTZza0V1NEkxQzZFN2RjejBEc3ZLUklUZUNOZQpWbXpmcFBrNW9FQ2hHcHdyYlJscyt3K0NPY1pTWlEyTGptNmRXelVtT001N3VYbHZsUmZGUDdrbGhKTUZNNUFlCmNnOTZIUUtCZ0YxOVVDL1J3R1BjN1RnNGxtRG5sYUlta0JvSjZWRGNpOUVIdUNVYUFyMXZ2d2FCbzNVTm4xaWoKdnQrUDVUV2FCU1l2OFh3Qnd5dkdRcFJ4TlkzVWxJb2tIYXE1d0IrKzc1Q2RObXhBTDF6Rnd5ZkR0eWRSR1dGNQp0cFdWbHJiamlsTVIrWEt3TnNnSXBMNUJla3RyMHBjN05mbWxXUFQvODQzWG1rTk4ybUtVCi0tLS0tRU5EIFJTQSBQUklWQVRFIEtFWS0tLS0tCg==
---
# Source: opa-kube-mgmt/templates/rbac-mgmt.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  labels:
    app: opa-kube-mgmt
    chart: opa-kube-mgmt-9.3.0
    release: open-policy-agent-0
    component: mgmt
  name: open-policy-agent-0-opa-kube-mgmt-mgmt
  namespace: default
rules:
  - apiGroups: [""]
    resources: ["configmaps"]
    verbs: ["get", "list", "watch", "update", "patch"]
---
# Source: opa-kube-mgmt/templates/rbac-mgmt.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  labels:
    app: opa-kube-mgmt
    chart: opa-kube-mgmt-9.3.0
    release: open-policy-agent-0
    component: mgmt
  name: open-policy-agent-0-opa-kube-mgmt-mgmt
  namespace: default
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: open-policy-agent-0-opa-kube-mgmt-mgmt
subjects:
  - kind: ServiceAccount
    name: open-policy-agent-0-opa-kube-mgmt
    namespace: default
---
# Source: opa-kube-mgmt/templates/service.yaml
kind: Service
apiVersion: v1
metadata:
  name: open-policy-agent-0-opa-kube-mgmt
  labels:
    app: open-policy-agent-0-opa-kube-mgmt
    chart: "opa-kube-mgmt-9.3.0"
    release: "open-policy-agent-0"
    heritage: "Helm"
spec:
  selector:
    app: open-policy-agent-0-opa-kube-mgmt
  ports:
  - name: opa
    port: 8181
    targetPort: opa
---
# Source: opa-kube-mgmt/templates/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: open-policy-agent-0-opa-kube-mgmt
  labels:
    app: open-policy-agent-0-opa-kube-mgmt
    chart: "opa-kube-mgmt-9.3.0"
    release: "open-policy-agent-0"
    heritage: "Helm"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: open-policy-agent-0-opa-kube-mgmt
  template:
    metadata:
      annotations:
      labels:
        app: open-policy-agent-0-opa-kube-mgmt
      name: open-policy-agent-0-opa-kube-mgmt
    spec:
      initContainers:
        - name: initpolicy
          image: openpolicyagent/kube-mgmt:9.3.0
          imagePullPolicy: IfNotPresent
          resources:
            {}
          command:
          - /bin/sh
          - -c
          - |
            tr -dc 'A-F0-9' < /dev/urandom | dd bs=1 count=32 2>/dev/null > /bootstrap/mgmt-token
            TOKEN=`cat /bootstrap/mgmt-token`
            cat > /bootstrap/authz.rego <<EOF
            package system.authz
            import rego.v1
            default allow := false
            # Allow anonymous access to the default policy decision.
            allow if { input.path = [""]; input.method == "POST" }
            allow if { input.path = [""]; input.method == "GET" }
            # This is only used for health check in liveness and readiness probe
            allow if { input.path = ["health"]; input.method == "GET" }
            allow if { input.identity == "$TOKEN" }
            EOF
          volumeMounts:
            - name: bootstrap
              mountPath: /bootstrap
      containers:
        - name: opa
          ports:
          - name: opa
            containerPort: 8181
          image: "openpolicyagent/opa:1.3.0"
          imagePullPolicy: IfNotPresent
          env:
          resources:
            {}
          args:
            - "run"
            - "--server"
            - "--tls-cert-file=/certs/tls.crt"
            - "--tls-private-key-file=/certs/tls.key"
            - "--addr=0.0.0.0:8181"
            - "--log-level=info"
            - "--log-format=json"
            - "--authentication=token"
            - "--authorization=basic"
            - "--ignore=.*"
            - "/bootstrap"
          volumeMounts:
            - name: certs
              readOnly: true
              mountPath: /certs
            - name: bootstrap
              readOnly: true
              mountPath: /bootstrap
          readinessProbe:
            httpGet:
              path: /health
              scheme: HTTPS
              port: opa
            initialDelaySeconds: 5
            periodSeconds: 10
          livenessProbe:
            httpGet:
              path: /health
              scheme: HTTPS
              port: opa
            initialDelaySeconds: 10
            periodSeconds: 15
        - name: mgmt
          image: openpolicyagent/kube-mgmt:9.3.0
          imagePullPolicy: IfNotPresent
          startupProbe:

            failureThreshold: 5
            httpGet:
              path: /health
              port: 8181
              scheme: HTTPS
            initialDelaySeconds: 20
            successThreshold: 1
            timeoutSeconds: 10
          env:
          resources:
            
            {}
          args:
            - --opa-auth-token-file=/bootstrap/mgmt-token
            - --opa-url=https://127.0.0.1:8181/v1
            - --opa-allow-insecure
            - "--namespaces=default"
            - "--enable-data=true"
            - "--enable-policies=true"

            - "--replicate-path=kubernetes"
            - "--replicate-ignore-namespaces="
          volumeMounts:
            - name: bootstrap
              readOnly: true
              mountPath: /bootstrap
      serviceAccountName: open-policy-agent-0-opa-kube-mgmt
      volumes:
        - name: certs
          secret:
            secretName: open-policy-agent-0-opa-kube-mgmt-cert
        - name: bootstrap
          emptyDir: {}
      affinity:
        {}
      nodeSelector:
        kubernetes.io/arch: amd64
      tolerations:
        []
      topologySpreadConstraints:
        []
