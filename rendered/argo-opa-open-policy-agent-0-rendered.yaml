---
# Source: opa-kube-mgmt/templates/serviceaccount.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: open-policy-agent-0-opa-kube-mgmt
  labels:
    app: open-policy-agent-0-opa-kube-mgmt
    chart: opa-kube-mgmt-9.3.0
    release: "open-policy-agent-0"
    heritage: "Helm"
---
# Source: opa-kube-mgmt/templates/webhookconfiguration.yaml
apiVersion: v1
kind: Secret
metadata:
  name: open-policy-agent-0-opa-kube-mgmt-cert
  labels:
    app: open-policy-agent-0-opa-kube-mgmt
    chart: "opa-kube-mgmt-9.3.0"
    release: "open-policy-agent-0"
    heritage: "Helm"
type: Opaque
data:
  tls.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURlakNDQW1LZ0F3SUJBZ0lSQUlYUnZiQjc3cVlEZWxWL01kR2l6U013RFFZSktvWklodmNOQVFFTEJRQXcKR3pFWk1CY0dBMVVFQXhNUWIzQmhMV0ZrYldsemMybHZiaTFqWVRBZUZ3MHlOakF4TVRFeE56STFNREZhRncwegpOakF4TURreE56STFNREZhTURneE5qQTBCZ05WQkFNVExXOXdaVzR0Y0c5c2FXTjVMV0ZuWlc1MExUQXRiM0JoCkxXdDFZbVV0YldkdGRDNWtaV1poZFd4MExuTjJZekNDQVNJd0RRWUpLb1pJaHZjTkFRRUJCUUFEZ2dFUEFEQ0MKQVFvQ2dnRUJBTkdYeDMwTGI4TUdxOU5Sdk1FcFdvWUZWUlZkSXRMQXZEUkYzaTNjdW5iZXp3bjEyYWhqSmh4egpKUWYzVmRUazN1WmlHWWF2SCtUOHB3NllBUUhYVnRLUXR1MStEZ3lYcTBFdHV0THltWHVqSWUvTUlxaXg0Q0NxCjVPVnVSeHJBd1N0RVRIR25RRWMwSUdacDc3M3F5U1ZDd3ZwamQ2Ty9hNlpJbnpTdmo5blJNMkJsZWFQaWVaWFAKbVIydnpiM0dCTldMNmpBZ0JDS0ZUTDg5VHYwSFdkZlJqN1NtRkk5V1FLMUtNUy94dTR0QmhBNnJSM3RaZFo3MwpvWEs4WEZBMTY0VXB1bHBqeW1zS3lDbnU3cllHK2VxazVqQnJLTkJ2MWtxRkxxYVJ0QXB3K0FRTUE5S1o0Q0JTCktFMVB1NEZodkhwL0V6eGFTbzc4M1ExcC8yRU0xZHNDQXdFQUFhT0JtekNCbURBT0JnTlZIUThCQWY4RUJBTUMKQmFBd0hRWURWUjBsQkJZd0ZBWUlLd1lCQlFVSEF3RUdDQ3NHQVFVRkJ3TUNNQXdHQTFVZEV3RUIvd1FDTUFBdwpId1lEVlIwakJCZ3dGb0FVWlVDc0dlcEtUS3hrZWE1NXNMRnpPWGpzSTR3d09BWURWUjBSQkRFd0w0SXRiM0JsCmJpMXdiMnhwWTNrdFlXZGxiblF0TUMxdmNHRXRhM1ZpWlMxdFoyMTBMbVJsWm1GMWJIUXVjM1pqTUEwR0NTcUcKU0liM0RRRUJDd1VBQTRJQkFRQjVXVnZ5VzUvT1ovaURwemhhRHBiWmQyR1F3SGJNWXgzU3ROaVpLdkZDemV2NgpUN3JlNFArbXBsZmZ1RTJpakYrT2I1MHdRcm9YeGs3RlFvZlpQMi9oS0hFTTNpak1yQ2VVY1N3dlZjL2lEa2JrCnFwaW9USmNBT055LzNFZmVEV21ZRGFvR0ZsbXBQckRnN29GRGpOVlN6OEJyVkRneEVXaTZQNGErMmpKeE5sUlMKK3EvVXdwZ251cVJEd0NRbmJNZnVSK0lCbGZpOTVCUkl0OWgxYWdjbVFSWlE5Z3R4MEl0cXEzZlRtak85L21oTAp4dGRDb1pUTmVpME5GM0xEd00yYXJzc2FnOE4xZHJuNzllTVhVMXlzTG0zNXVNeXhqZWJzWldmc0lCa2pqeVZHCnpzYUF5ZFNYMzFnTzlDS3praGdpRlE4WlJEWERFOStibTNySXY4a3EKLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=
  tls.key: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFb3dJQkFBS0NBUUVBMFpmSGZRdHZ3d2FyMDFHOHdTbGFoZ1ZWRlYwaTBzQzhORVhlTGR5NmR0N1BDZlhaCnFHTW1ISE1sQi9kVjFPVGU1bUlaaHE4ZjVQeW5EcGdCQWRkVzBwQzI3WDRPREplclFTMjYwdktaZTZNaDc4d2kKcUxIZ0lLcms1VzVIR3NEQkswUk1jYWRBUnpRZ1ptbnZ2ZXJKSlVMQyttTjNvNzlycGtpZk5LK1AyZEV6WUdWNQpvK0o1bGMrWkhhL052Y1lFMVl2cU1DQUVJb1ZNdnoxTy9RZFoxOUdQdEtZVWoxWkFyVW94TC9HN2kwR0VEcXRICmUxbDFudmVoY3J4Y1VEWHJoU202V21QS2F3cklLZTd1dGdiNTZxVG1NR3NvMEcvV1NvVXVwcEcwQ25ENEJBd0QKMHBuZ0lGSW9UVSs3Z1dHOGVuOFRQRnBLanZ6ZERXbi9ZUXpWMndJREFRQUJBb0lCQUFST001emhDNm9HNGYxQgpjUDB3OCtHaGNxMlg4QS9iL1hDdWhhMDRDaGUvMUR4c3o0ZzRRa0dnOVBlRWhxWXU3ZkthSXlnWnkwRUFTY3VTCjBXU2NzSDNseGhHTXZHdlFNMlJFMXdSd3VjRmFLeEpNeWNCcFk4OUR0N1dkTzhsK290Y1VCdVRwL2ZmbmFoYTAKd2QxNkZOTzJ1TmUwdHRoUjRXWTdtSG1rL2VCdW55UGhNenpJVHRxbnV4bUp3MGVENVZMejluQmFyL2xPSnFUQgpHVnc5eUFxUXBEOG5aYmpsNko2Mk1jdW1XS1F1cm82VkRRRXdrcGFhNkNjcVk5dWRBVHBmeHZqWUhDLzVEM3BMCmxTOUdoUXVMMnlRdTAzVExsTXpPMlRyd0MrditzWGlNOVhMenZ3VWNBWW5xb1RONEFnUVJMa3NjNC9WTXY0cXEKRXJHeldaRUNnWUVBNlRLUEw2RjNSUGpnbnJPTmIvdmdLRW1GQmJKTmxvM1ppblVsZzRSQVV0cVk5Mkx4TE8xNwpsYVpwY3FPTEZPcURva1haSEhLdmRHQ3JHeDlRK1oyOGc2UEJZaHltVHFxbzJqeVhhNTJiQVozYVF1NVNBQWVwCjJaaG5PaWZ6Y1FRVUhoRlJJYitLdjNQYlVQbmcyVWl2VUNKbFhTVWlxMFVWZ3lpYzEzeDZiZVVDZ1lFQTVoWlkKWHdnQnpUMGkwcmpzTzJOSC8rZ1lyaEoySnlZSEJKaDhaejd1T0w1M2VJbm9ndDZsdUJGU0x2S0FEUThwSGFpWQpMNVBDeEd4V0pGR1JHR0k5OTg2T1RCcnRGR1I5aElhb3Qva1FkUFFPOW9OM253R1k3dzZzNjF0cGc1Z0JtaXlpCkQ4RUtJMkJCOU1CWTk5UnJnU1ZFSXRyQU9xWEhmNkdDUjg1VCtMOENnWUVBZ3RnZmh6WXQyY0ZiSnpEUDExbVkKT0lLbjVMNWEwbkxjOE5jeUtVejNXb1hVOWxuSndNK3ZYQlIzYmg5ZFZtc1BXT21nSEZvdElEdHRSbGFYOUxjUQpvendxc1lZcHVsSC9WQlJUVWNxb3dvdHpmOEtBdUF1VXZjYkpoTlFOd0FmdDBjRWRxTFgwZjkvZDJ0Mlp6OUQ4CnJSWGZraGZZRUFrL1BNeDQxRisvd2hFQ2dZQUk0c1lJN1lNOFRPY2lZamZsVjBFNWxkb1dKdXBmT3EyOHRMTGgKUGVIdldSTytHUDFjeUlKMzZGdFhLdEJkTUwreXdJY1lGMG5IVWpQRmRVejROeHNUamV1YTd0TkhIVlpubnRlMwpPeXd5aUJabjJNM3UyeDN2NVk0eURMYTNlVkJlaHVpL1dRSXVPWkp5aEZjclF3M2Z6L09nc1BnSmk4dDNsMkl6CnFiaytld0tCZ0QzRGFLZko4VmhUOHg1YkM5VFl0YVpyL1Vld0VBRFRzS2ZhSzFuY0xnaE5tVmNQdXA3UFpocXUKaWRIaXd1b292UTZKNlJIYUt2cjZjRHJGS1ordEpzQXNjelY2SVpOWmV4Z2xTSkYrNHh4VGNqS3A5SlVKb29hLwpYZFNZYlhnZUJnWUtVUVV1Sit5ZXJDUVBEWFJLNlNtZFFVVG1BRFJYR3dxSmR4RDFkeFA4Ci0tLS0tRU5EIFJTQSBQUklWQVRFIEtFWS0tLS0tCg==
---
# Source: opa-kube-mgmt/templates/rbac-mgmt.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  labels:
    app: opa-kube-mgmt
    chart: opa-kube-mgmt-9.3.0
    release: open-policy-agent-0
    component: mgmt
  name: open-policy-agent-0-opa-kube-mgmt-mgmt
  namespace: default
rules:
  - apiGroups: [""]
    resources: ["configmaps"]
    verbs: ["get", "list", "watch", "update", "patch"]
---
# Source: opa-kube-mgmt/templates/rbac-mgmt.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  labels:
    app: opa-kube-mgmt
    chart: opa-kube-mgmt-9.3.0
    release: open-policy-agent-0
    component: mgmt
  name: open-policy-agent-0-opa-kube-mgmt-mgmt
  namespace: default
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: open-policy-agent-0-opa-kube-mgmt-mgmt
subjects:
  - kind: ServiceAccount
    name: open-policy-agent-0-opa-kube-mgmt
    namespace: default
---
# Source: opa-kube-mgmt/templates/service.yaml
kind: Service
apiVersion: v1
metadata:
  name: open-policy-agent-0-opa-kube-mgmt
  labels:
    app: open-policy-agent-0-opa-kube-mgmt
    chart: "opa-kube-mgmt-9.3.0"
    release: "open-policy-agent-0"
    heritage: "Helm"
spec:
  selector:
    app: open-policy-agent-0-opa-kube-mgmt
  ports:
  - name: opa
    port: 8181
    targetPort: opa
---
# Source: opa-kube-mgmt/templates/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: open-policy-agent-0-opa-kube-mgmt
  labels:
    app: open-policy-agent-0-opa-kube-mgmt
    chart: "opa-kube-mgmt-9.3.0"
    release: "open-policy-agent-0"
    heritage: "Helm"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: open-policy-agent-0-opa-kube-mgmt
  template:
    metadata:
      annotations:
      labels:
        app: open-policy-agent-0-opa-kube-mgmt
      name: open-policy-agent-0-opa-kube-mgmt
    spec:
      initContainers:
        - name: initpolicy
          image: openpolicyagent/kube-mgmt:9.3.0
          imagePullPolicy: IfNotPresent
          resources:
            {}
          command:
          - /bin/sh
          - -c
          - |
            tr -dc 'A-F0-9' < /dev/urandom | dd bs=1 count=32 2>/dev/null > /bootstrap/mgmt-token
            TOKEN=`cat /bootstrap/mgmt-token`
            cat > /bootstrap/authz.rego <<EOF
            package system.authz
            import rego.v1
            default allow := false
            # Allow anonymous access to the default policy decision.
            allow if { input.path = [""]; input.method == "POST" }
            allow if { input.path = [""]; input.method == "GET" }
            # This is only used for health check in liveness and readiness probe
            allow if { input.path = ["health"]; input.method == "GET" }
            allow if { input.identity == "$TOKEN" }
            EOF
          volumeMounts:
            - name: bootstrap
              mountPath: /bootstrap
      containers:
        - name: opa
          ports:
          - name: opa
            containerPort: 8181
          image: "openpolicyagent/opa:1.3.0"
          imagePullPolicy: IfNotPresent
          env:
          resources:
            {}
          args:
            - "run"
            - "--server"
            - "--tls-cert-file=/certs/tls.crt"
            - "--tls-private-key-file=/certs/tls.key"
            - "--addr=0.0.0.0:8181"
            - "--log-level=info"
            - "--log-format=json"
            - "--authentication=token"
            - "--authorization=basic"
            - "--ignore=.*"
            - "/bootstrap"
          volumeMounts:
            - name: certs
              readOnly: true
              mountPath: /certs
            - name: bootstrap
              readOnly: true
              mountPath: /bootstrap
          readinessProbe:
            httpGet:
              path: /health
              scheme: HTTPS
              port: opa
            initialDelaySeconds: 5
            periodSeconds: 10
          livenessProbe:
            httpGet:
              path: /health
              scheme: HTTPS
              port: opa
            initialDelaySeconds: 10
            periodSeconds: 15
        - name: mgmt
          image: openpolicyagent/kube-mgmt:9.3.0
          imagePullPolicy: IfNotPresent
          startupProbe:

            failureThreshold: 5
            httpGet:
              path: /health
              port: 8181
              scheme: HTTPS
            initialDelaySeconds: 20
            successThreshold: 1
            timeoutSeconds: 10
          env:
          resources:
            
            {}
          args:
            - --opa-auth-token-file=/bootstrap/mgmt-token
            - --opa-url=https://127.0.0.1:8181/v1
            - --opa-allow-insecure
            - "--namespaces=default"
            - "--enable-data=true"
            - "--enable-policies=true"

            - "--replicate-path=kubernetes"
            - "--replicate-ignore-namespaces="
          volumeMounts:
            - name: bootstrap
              readOnly: true
              mountPath: /bootstrap
      serviceAccountName: open-policy-agent-0-opa-kube-mgmt
      volumes:
        - name: certs
          secret:
            secretName: open-policy-agent-0-opa-kube-mgmt-cert
        - name: bootstrap
          emptyDir: {}
      affinity:
        {}
      nodeSelector:
        kubernetes.io/arch: amd64
      tolerations:
        []
      topologySpreadConstraints:
        []
