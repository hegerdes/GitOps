---
# Source: opa-kube-mgmt/templates/serviceaccount.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: open-policy-agent-0-opa-kube-mgmt
  labels:
    app: open-policy-agent-0-opa-kube-mgmt
    chart: opa-kube-mgmt-9.3.0
    release: "open-policy-agent-0"
    heritage: "Helm"
---
# Source: opa-kube-mgmt/templates/webhookconfiguration.yaml
apiVersion: v1
kind: Secret
metadata:
  name: open-policy-agent-0-opa-kube-mgmt-cert
  labels:
    app: open-policy-agent-0-opa-kube-mgmt
    chart: "opa-kube-mgmt-9.3.0"
    release: "open-policy-agent-0"
    heritage: "Helm"
type: Opaque
data:
  tls.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURlVENDQW1HZ0F3SUJBZ0lRVEtMYkQ5TTczYjJ4RkpkVzZNTUxNREFOQmdrcWhraUc5dzBCQVFzRkFEQWIKTVJrd0Z3WURWUVFERXhCdmNHRXRZV1J0YVhOemFXOXVMV05oTUI0WERUSTJNREV3TXpFMU5UY3lNVm9YRFRNMgpNREV3TVRFMU5UY3lNVm93T0RFMk1EUUdBMVVFQXhNdGIzQmxiaTF3YjJ4cFkza3RZV2RsYm5RdE1DMXZjR0V0CmEzVmlaUzF0WjIxMExtUmxabUYxYkhRdWMzWmpNSUlCSWpBTkJna3Foa2lHOXcwQkFRRUZBQU9DQVE4QU1JSUIKQ2dLQ0FRRUFzeWdKOS9XYXVFL2pYWmo4WHhtVFNaeDRPNnhZTnhkWG9KNDNpYmVOMmNNZFVLQThrMm9DS05JUgpQaEZkN0cxUlRSRnJkMDRiN1pLc25vOG82L0tKdW0zdHBwbnU3ZzgyYzhSN2RmZFI5UmVoWUtjdSs0Ty80dzJECjZsTCt0TjRUVmVqeU9NOWdDWTNFOWJJRlNscWU4MHdROE9YNkk1L3BoSDk0THJMTEdISmFJNTE3NDV2UEZudWcKWllQL29XR1N0MjZVeEg2WWpOTnRUK1pkcGI1MzJSa1R4R0RDVTEzV2hwbGx3M1J6ZTNKNnQ2SnludnB0WlR0dwo0OWVIeVRxMFlpbnhvdHQrRG03VkpWemswTFkvbng5SEh0R0ZpUERodXZYbU1KeGhEWXlKM1cyY0ZSSzZpWjdBCjY3N24zZ0JGQURtUVJRVlFZQWlBMlVGWlhuVDU3UUlEQVFBQm80R2JNSUdZTUE0R0ExVWREd0VCL3dRRUF3SUYKb0RBZEJnTlZIU1VFRmpBVUJnZ3JCZ0VGQlFjREFRWUlLd1lCQlFVSEF3SXdEQVlEVlIwVEFRSC9CQUl3QURBZgpCZ05WSFNNRUdEQVdnQlQ5V1B4QmRrUE1kUW5FNTBJK0oxSE1sOVhhTERBNEJnTlZIUkVFTVRBdmdpMXZjR1Z1CkxYQnZiR2xqZVMxaFoyVnVkQzB3TFc5d1lTMXJkV0psTFcxbmJYUXVaR1ZtWVhWc2RDNXpkbU13RFFZSktvWkkKaHZjTkFRRUxCUUFEZ2dFQkFPdVpGYldJcEFhZ25MYkJHOUU2alFqM05BMXJEdy9TaDc1aDh4bXozWWhOYzVKdgpYV0NnSmFUU3pZZVM1cUZUdXhNelczMlBnOTkxaHBEMWdHRTFRekV5QWFXemN2NWl2dFlqcGIxSmwyWEF3cHVRCmxWcTBpVGlEL3hSUE5nS1NTMHA4dTZHVi9Fa1BoK2VmMnNVakt0NGFpelFmSWxwN1ErdUMzMzZOaGpyZXlhZ1IKU3hDOGNrQjJoaFJvMmJGZlBUNUYwcHlEaEc4UndkbHNCTDF3aTBBQVNmZDJNbVUwL0NHMjlyUTRkL1MrQnJpRgpxQWhoMmVua3dRRWVFZFBRMXBWeTF2a1lmMWEreG10eUR1a002S1JlbHEwdGxyN2NwWjNJNEwzcDdrSVRMV1FtCjJwVTgyNVBHOEVrZzFkc2QrMHJHR3FGekRRcnBlUFJlV2ZpN0dsOD0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=
  tls.key: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFcEFJQkFBS0NBUUVBc3lnSjkvV2F1RS9qWFpqOFh4bVRTWng0TzZ4WU54ZFhvSjQzaWJlTjJjTWRVS0E4Cmsyb0NLTklSUGhGZDdHMVJUUkZyZDA0YjdaS3NubzhvNi9LSnVtM3RwcG51N2c4MmM4UjdkZmRSOVJlaFlLY3UKKzRPLzR3MkQ2bEwrdE40VFZlanlPTTlnQ1kzRTliSUZTbHFlODB3UThPWDZJNS9waEg5NExyTExHSEphSTUxNwo0NXZQRm51Z1pZUC9vV0dTdDI2VXhINllqTk50VCtaZHBiNTMyUmtUeEdEQ1UxM1docGxsdzNSemUzSjZ0Nkp5Cm52cHRaVHR3NDllSHlUcTBZaW54b3R0K0RtN1ZKVnprMExZL254OUhIdEdGaVBEaHV2WG1NSnhoRFl5SjNXMmMKRlJLNmlaN0E2NzduM2dCRkFEbVFSUVZRWUFpQTJVRlpYblQ1N1FJREFRQUJBb0lCQUJMYjRGN0NjeGk3U2gwUQpiV0tLWSt1QUJkVU1RWlg5Qmt1aFZBblNjV051cTArUktvYy9CYjZyekVaYkdDYTY1Qy9IYVdkYjZNc3pvU21vCnVyOUpudTlwd25aQzVuaVhUOTFVWGNXdmRPaG1waVZ4Tzl3Y2hJNi9YYmRGS013N3cwL01EM0ZrL1FCTWRPTUQKTEJUbFlLMk9RSXRIUGpOUlVralJEVUxuTGNOakd3R3pMVk5uZU9GV0RZUlFFZTZYeHJUNjkzTzlqazJzWVdEZwo0djk3VlhCajRjL0kzNUxpbFkycEIvMnZWM00zcE5yMFU3NkVYTkE0TXJacGNkaEwvZGozZE1XVEVrNDI5cHQ1Cld4NEg0dWZjUGw0N0h2eFFTbUNzL1hzVzdmaTU0MS9lMUNUZjJGenlVZC9lM1JJUWRWNEg3NzdFS3VxUlNQWXoKOU9oT050RUNnWUVBNVd5emdZTjMvSEhQR0JlL3MxVTRYQ0RKNlo1WHRHelk4K21QUVhDRFJHNUpzQmJuL00rUAprRVNhS2U4WE9BUW51V2JGMXBvQnY1MXRuaVpEdmlvbWJvWDBzTVhTdXpoeWFOVldRc3Y2R00zSzY2WUJBRnB1CnZKUDR5bmx3QWtFZkdOaFh2dTRrdjVrcytjdlVqY1A5dWVrOVMybWlreXlBbmhheHp4QXlEaEVDZ1lFQXgraXkKY2RlZ1lBaFNOM00zQ1dVTEoxMVZIdE41Z0dYQTVpSzZodzUzL3dvK0kvZEtwcjRiS2pSSVMwbE91aTNPR01rVApnTzFOUEhDWEVEY2xxTmlPZVZsdGRFSFJDZEF0aXRoK0dXaXg2WUYrdWZORm0yY1J6V1NKbW0vZE1ELzFzSTdaCjZrTWtPVHVuNm9BUUt0aldidnNSblU1Wm5PcndrM3oxUkttWlFoMENnWUVBejd6anRXd2pvelF5UHpDUjVvSk4KN0MzTVpudDRFdWxVY1ZlVTNiNVJQZzlYTGRrdjZwek84K1VLYXRvUmZpbFZCdTNtU2ZGZGovR3VwanNqci9kZQpvVWt1VFRwekhBOTZtUzVEVTJ4N1l5WkVqYWZjMUVNT2JqYldXaEFudWdMWmM1ZkJyQ0xhcDVxOVBOcXg5a1AzClpQV3JDTFAzLzZlV05vOTZKWElXd09FQ2dZQlp3Sy9kVE9KRU8zZ3VUUnc0cTVVR1ozRUFGaEpIQTJoSDZ1KzAKRTFyc3RyeVBpVWVLOVc5YzAzeGgwTmYzM3ZqWlIrM3B4S0VZc2JRaEk2RlUzV1dhTmZ4ZVplNWthWU1KQTRvWgovbGRpYnpGbWEwS2xNdkZiTmZoUnprZVFraWJNemxZb1Ixek1GV3llYkVEVisrVEtqdzZwZ2JQYUwrRXpWcmNICnpOMXlRUUtCZ1FEV3FsSlR2SkVtZFlNQ29TMUxwWVRha29LU1BtSFRPZ3Z2OVdGYmdZVmN4VUlmU25pK2thWW8KeUMreDBWalh4UWNLclh3S0kxVS9LVlBJZkpnc3hCQVJURTk2bGJrK0hZZ0RwNFRReHREbHppZ05XazA1MmltZwpZdGx4TUlFb2NJaEhucHJEU3RQMXYzMnRZUEcyYllPallOL0xRZVZZckkxWHVpbnVvK2E4QXc9PQotLS0tLUVORCBSU0EgUFJJVkFURSBLRVktLS0tLQo=
---
# Source: opa-kube-mgmt/templates/rbac-mgmt.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  labels:
    app: opa-kube-mgmt
    chart: opa-kube-mgmt-9.3.0
    release: open-policy-agent-0
    component: mgmt
  name: open-policy-agent-0-opa-kube-mgmt-mgmt
  namespace: default
rules:
  - apiGroups: [""]
    resources: ["configmaps"]
    verbs: ["get", "list", "watch", "update", "patch"]
---
# Source: opa-kube-mgmt/templates/rbac-mgmt.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  labels:
    app: opa-kube-mgmt
    chart: opa-kube-mgmt-9.3.0
    release: open-policy-agent-0
    component: mgmt
  name: open-policy-agent-0-opa-kube-mgmt-mgmt
  namespace: default
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: open-policy-agent-0-opa-kube-mgmt-mgmt
subjects:
  - kind: ServiceAccount
    name: open-policy-agent-0-opa-kube-mgmt
    namespace: default
---
# Source: opa-kube-mgmt/templates/service.yaml
kind: Service
apiVersion: v1
metadata:
  name: open-policy-agent-0-opa-kube-mgmt
  labels:
    app: open-policy-agent-0-opa-kube-mgmt
    chart: "opa-kube-mgmt-9.3.0"
    release: "open-policy-agent-0"
    heritage: "Helm"
spec:
  selector:
    app: open-policy-agent-0-opa-kube-mgmt
  ports:
  - name: opa
    port: 8181
    targetPort: opa
---
# Source: opa-kube-mgmt/templates/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: open-policy-agent-0-opa-kube-mgmt
  labels:
    app: open-policy-agent-0-opa-kube-mgmt
    chart: "opa-kube-mgmt-9.3.0"
    release: "open-policy-agent-0"
    heritage: "Helm"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: open-policy-agent-0-opa-kube-mgmt
  template:
    metadata:
      annotations:
      labels:
        app: open-policy-agent-0-opa-kube-mgmt
      name: open-policy-agent-0-opa-kube-mgmt
    spec:
      initContainers:
        - name: initpolicy
          image: openpolicyagent/kube-mgmt:9.3.0
          imagePullPolicy: IfNotPresent
          resources:
            {}
          command:
          - /bin/sh
          - -c
          - |
            tr -dc 'A-F0-9' < /dev/urandom | dd bs=1 count=32 2>/dev/null > /bootstrap/mgmt-token
            TOKEN=`cat /bootstrap/mgmt-token`
            cat > /bootstrap/authz.rego <<EOF
            package system.authz
            import rego.v1
            default allow := false
            # Allow anonymous access to the default policy decision.
            allow if { input.path = [""]; input.method == "POST" }
            allow if { input.path = [""]; input.method == "GET" }
            # This is only used for health check in liveness and readiness probe
            allow if { input.path = ["health"]; input.method == "GET" }
            allow if { input.identity == "$TOKEN" }
            EOF
          volumeMounts:
            - name: bootstrap
              mountPath: /bootstrap
      containers:
        - name: opa
          ports:
          - name: opa
            containerPort: 8181
          image: "openpolicyagent/opa:1.3.0"
          imagePullPolicy: IfNotPresent
          env:
          resources:
            {}
          args:
            - "run"
            - "--server"
            - "--tls-cert-file=/certs/tls.crt"
            - "--tls-private-key-file=/certs/tls.key"
            - "--addr=0.0.0.0:8181"
            - "--log-level=info"
            - "--log-format=json"
            - "--authentication=token"
            - "--authorization=basic"
            - "--ignore=.*"
            - "/bootstrap"
          volumeMounts:
            - name: certs
              readOnly: true
              mountPath: /certs
            - name: bootstrap
              readOnly: true
              mountPath: /bootstrap
          readinessProbe:
            httpGet:
              path: /health
              scheme: HTTPS
              port: opa
            initialDelaySeconds: 5
            periodSeconds: 10
          livenessProbe:
            httpGet:
              path: /health
              scheme: HTTPS
              port: opa
            initialDelaySeconds: 10
            periodSeconds: 15
        - name: mgmt
          image: openpolicyagent/kube-mgmt:9.3.0
          imagePullPolicy: IfNotPresent
          startupProbe:

            failureThreshold: 5
            httpGet:
              path: /health
              port: 8181
              scheme: HTTPS
            initialDelaySeconds: 20
            successThreshold: 1
            timeoutSeconds: 10
          env:
          resources:
            
            {}
          args:
            - --opa-auth-token-file=/bootstrap/mgmt-token
            - --opa-url=https://127.0.0.1:8181/v1
            - --opa-allow-insecure
            - "--namespaces=default"
            - "--enable-data=true"
            - "--enable-policies=true"

            - "--replicate-path=kubernetes"
            - "--replicate-ignore-namespaces="
          volumeMounts:
            - name: bootstrap
              readOnly: true
              mountPath: /bootstrap
      serviceAccountName: open-policy-agent-0-opa-kube-mgmt
      volumes:
        - name: certs
          secret:
            secretName: open-policy-agent-0-opa-kube-mgmt-cert
        - name: bootstrap
          emptyDir: {}
      affinity:
        {}
      nodeSelector:
        kubernetes.io/arch: amd64
      tolerations:
        []
      topologySpreadConstraints:
        []
