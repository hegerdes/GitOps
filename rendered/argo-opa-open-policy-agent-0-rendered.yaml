---
# Source: opa-kube-mgmt/templates/serviceaccount.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: open-policy-agent-0-opa-kube-mgmt
  labels:
    app: open-policy-agent-0-opa-kube-mgmt
    chart: opa-kube-mgmt-9.3.0
    release: "open-policy-agent-0"
    heritage: "Helm"
---
# Source: opa-kube-mgmt/templates/webhookconfiguration.yaml
apiVersion: v1
kind: Secret
metadata:
  name: open-policy-agent-0-opa-kube-mgmt-cert
  labels:
    app: open-policy-agent-0-opa-kube-mgmt
    chart: "opa-kube-mgmt-9.3.0"
    release: "open-policy-agent-0"
    heritage: "Helm"
type: Opaque
data:
  tls.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURlakNDQW1LZ0F3SUJBZ0lSQUlGcUN4cnJ1NThsa1ExUXMySlcrbzR3RFFZSktvWklodmNOQVFFTEJRQXcKR3pFWk1CY0dBMVVFQXhNUWIzQmhMV0ZrYldsemMybHZiaTFqWVRBZUZ3MHlOakF4TURNeE5URXhNak5hRncwegpOakF4TURFeE5URXhNak5hTURneE5qQTBCZ05WQkFNVExXOXdaVzR0Y0c5c2FXTjVMV0ZuWlc1MExUQXRiM0JoCkxXdDFZbVV0YldkdGRDNWtaV1poZFd4MExuTjJZekNDQVNJd0RRWUpLb1pJaHZjTkFRRUJCUUFEZ2dFUEFEQ0MKQVFvQ2dnRUJBTitWdGRLUFUyV0JhSkhvcnZ3M1pkSlUybUZhQkZOMkYreTNqY1FObWpxcFYrRjFzWDBwNWVKMApqZXdVN1J1Ni9IVmVoVEtkdVUxZXNmZng0ZGFOdnJ5SWVZbUdTRGd2UUVnSUFyRGx5aG1hS1A0cTBaL2t4NHczCnlRM1lhb0g2a0d3c251VnljTWkxOFNXNVJSNDBmd1JNbWNaZG1xUE9oaG5FTHlWdFVLbGNhdkxNQWdmOHJmS1MKaWxBci9Td29pR3czcENBK21IZE9oOStleHhlZm9LSUkxRlRHS2xhVWxvQWpPSWptdEVHTk5POE1hMWE3eC9KeApqcmd5RFBLY21vUXFIemJDVTFaZWpvbGYxb1VjaUpjYkljcHB6WmtYNUpUNTcvdnQ2WWNHOHZFRW5UT0lmdFlwClVnK1J5UVBhemtOd2RiK3JMZG9LNlN2b1R3emNiaGNDQXdFQUFhT0JtekNCbURBT0JnTlZIUThCQWY4RUJBTUMKQmFBd0hRWURWUjBsQkJZd0ZBWUlLd1lCQlFVSEF3RUdDQ3NHQVFVRkJ3TUNNQXdHQTFVZEV3RUIvd1FDTUFBdwpId1lEVlIwakJCZ3dGb0FVdFJ1TW1ENmFGS3N5L09TNHR0VnFtR0xtMFI4d09BWURWUjBSQkRFd0w0SXRiM0JsCmJpMXdiMnhwWTNrdFlXZGxiblF0TUMxdmNHRXRhM1ZpWlMxdFoyMTBMbVJsWm1GMWJIUXVjM1pqTUEwR0NTcUcKU0liM0RRRUJDd1VBQTRJQkFRREI2QTBkRXk3QnJaYXdoakRjbG5pQk5rYThjV1o2bGh0eWlVTWdmUXdSZW1OZgpQcVJ3R3VPTHVRU3FGZlE0TjJFRmUvc2NOM2M2eWdDSEVpY3JvcTExaVFBbFZtMk10YmZHTkF1MkpxSWFTRXNTCkFjN2F5aVE2VjZ0YnVNQ3E1OEo5cDQrdmo3OCszaEhSclJOQVgyOU9xczZyZkRGU1h4Z21nRTFUTVdkYm5VLzUKbG5FNU1LR0VCcjNUZWFqSXlkLzBpaTlZdVo0dnVGaS9wUVJXUWVjbFZpdXhpY2Jqb1NuQWVJREh4cktVemY2cQplUm1mR2dBYXRqRmxSejUrQmpHOXI0b3czbUNsZUVXUFpJSjFjMyt6UmFVL3ZNY3o5WFRESVhpRkJEZXRVSXI1CkFOYzFSYWZ5N0MzMEVRTEZxRkp2eklJR1RMZ1pCbmlUMXdnL01yMnIKLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=
  tls.key: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFcEFJQkFBS0NBUUVBMzVXMTBvOVRaWUZva2VpdS9EZGwwbFRhWVZvRVUzWVg3TGVOeEEyYU9xbFg0WFd4CmZTbmw0blNON0JUdEc3cjhkVjZGTXAyNVRWNng5L0hoMW8yK3ZJaDVpWVpJT0M5QVNBZ0NzT1hLR1pvby9pclIKbitUSGpEZkpEZGhxZ2ZxUWJDeWU1WEp3eUxYeEpibEZIalIvQkV5WnhsMmFvODZHR2NRdkpXMVFxVnhxOHN3QwpCL3l0OHBLS1VDdjlMQ2lJYkRla0lENllkMDZIMzU3SEY1K2dvZ2pVVk1ZcVZwU1dnQ000aU9hMFFZMDA3d3hyClZydkg4bkdPdURJTThweWFoQ29mTnNKVFZsNk9pVi9XaFJ5SWx4c2h5bW5ObVJma2xQbnYrKzNwaHdieThRU2QKTTRoKzFpbFNENUhKQTlyT1EzQjF2NnN0MmdycEsraFBETnh1RndJREFRQUJBb0lCQUZIdGEyTTlCcXVldUVFaQorSi9OOHQ4WUhhOW5pMGREOGk5WThUY2lYdDNZK0sxU2NaZXlGeDBjWlhiWkVpdERvTWVuTzNxWkpmSHVYWnRECnhHUFlxOGdzNEJBZkp1NkRqZlAzRDNsZnNtY2dRSjRsOVlzNEMxRGJqaTRuRzV3R1F3NklhUzhkZUt0clUvSmwKU2Fqd1JveStQdWpibXRNa1Zhb3lZNjQ4dUw1ZHdnRHhDbEZHQ1UxQ1Mrb2pvUnphZTQ0d2Z0TWs2R2wvbkh1WApnSVJFT1lPUEptWE1Lc29kYUd0OGZvU3llRDA5dDg3VzI2RXhCSjJ3QjB0bjZ4MzJMTXhTMmZtWEdVQ1dhUXFqCm56K2taTGwvMGp0a2VxSFNHb21QTU9oTTd1eTh6VVR6SENqbFJFYWQ3b1k4MldubFQzTVZzRVUwbU9CRVhPbTEKTmRIQ2VJVUNnWUVBNUN1akJPMFpPNVpMWmlnWEVvWldKVDBzbzRQd3VtMGNzMmxxelRTbVI3RE5aNmVEZGhVOApWVW82eTdoZ0djUGdjZ2h6RHU1alJTVFJ5VGpnN1V1TnMvdnJmVldoY2VaN0xIL0wzUEYwMElyOXR1WTVqdHBXCjU0T2kzdEJHLy9SaTg3aTFwUlBPRlZzV1NQODVDUHJTdXdFZHlGVVJDdEZXcklhYUpBeHQ3NFVDZ1lFQSt0cmsKUitDNlV2ZmcrNEVsdmJjTzh2dW8vMWlJM2FLL1lHbVBad015Z29rVjFrY09FWDN1RnRPZkhWaUtMT0t6eDlNLwp2YU9WUXFNYXNIeWFBZUthWmNCWkM1SWlxRCtRVFJXTzhjbGk4aWJyYUcvdVhWanlPV3lZTTQ5OG1YeHRlRVpaCmFrTk90YjdKTU1WNTFuNW5VTG9nWGpaSjE5bFB2RmFuSTArSEErc0NnWUFpYXlxMkxZWG01UzhPZy9HbkM3aW0KK1dsb2FSakJKb0J6MSswU2MyUzUzOE84WlJxQmo0YUFYeWdyWHU2d05Fb0JLYUVobVhoRUQ5L05lTlVGTnFaegpoZ2JwNnlibFpaMGpBMHdmVWhVSytFeDVjSlV5SldHQ251ck1yYUpvTGRkWGFIK09IVVN6R0FCdWxvRm1CMkFPCmNZYXFsNXB3aFUrTHl1b3BrZTVyZVFLQmdRQ1Rva043Y2V6MmEyQURaS3g3ak1MRmlncVp6TmN2NlZwTU9aUG0KQW1HMXBVd3V3YjZyMkx0SXY5OEMvRnJGczk0dW1rc0hKc0R2YU9LS1A2cTd0VXM4MndrTTRFSjVWbjlzZm1XVQpNdnVDbkJrcmE4U1RONGZHOS94VFMveityOVlWVlFIR29qb3VpRXdMNGd5a2lkdndETHFEOTl0WnAxRmYvSGQ5Ck5vNjFaUUtCZ1FEZU5YdnZybFU3bVFtSWJtb2U4UnFuMGYxb1VYME5XbitzTkwyeHNVTlJsbHJRNklVSjRtV1EKNzllTXN1MW9EVUxTUzNnRVBHaGhXcUNPd3RhcE9hWkNCYnRSdGN1aVRZRHBzL0RhRHUrM1dmK285bmw5b0Y2QgpSai9rT3JncVlCYXh0WkdFd0Vwa3YrQ0R1WGVjMzRxTUR2blUxZTg0RXlhRUpyVytSdnMvakE9PQotLS0tLUVORCBSU0EgUFJJVkFURSBLRVktLS0tLQo=
---
# Source: opa-kube-mgmt/templates/rbac-mgmt.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  labels:
    app: opa-kube-mgmt
    chart: opa-kube-mgmt-9.3.0
    release: open-policy-agent-0
    component: mgmt
  name: open-policy-agent-0-opa-kube-mgmt-mgmt
  namespace: default
rules:
  - apiGroups: [""]
    resources: ["configmaps"]
    verbs: ["get", "list", "watch", "update", "patch"]
---
# Source: opa-kube-mgmt/templates/rbac-mgmt.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  labels:
    app: opa-kube-mgmt
    chart: opa-kube-mgmt-9.3.0
    release: open-policy-agent-0
    component: mgmt
  name: open-policy-agent-0-opa-kube-mgmt-mgmt
  namespace: default
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: open-policy-agent-0-opa-kube-mgmt-mgmt
subjects:
  - kind: ServiceAccount
    name: open-policy-agent-0-opa-kube-mgmt
    namespace: default
---
# Source: opa-kube-mgmt/templates/service.yaml
kind: Service
apiVersion: v1
metadata:
  name: open-policy-agent-0-opa-kube-mgmt
  labels:
    app: open-policy-agent-0-opa-kube-mgmt
    chart: "opa-kube-mgmt-9.3.0"
    release: "open-policy-agent-0"
    heritage: "Helm"
spec:
  selector:
    app: open-policy-agent-0-opa-kube-mgmt
  ports:
  - name: opa
    port: 8181
    targetPort: opa
---
# Source: opa-kube-mgmt/templates/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: open-policy-agent-0-opa-kube-mgmt
  labels:
    app: open-policy-agent-0-opa-kube-mgmt
    chart: "opa-kube-mgmt-9.3.0"
    release: "open-policy-agent-0"
    heritage: "Helm"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: open-policy-agent-0-opa-kube-mgmt
  template:
    metadata:
      annotations:
      labels:
        app: open-policy-agent-0-opa-kube-mgmt
      name: open-policy-agent-0-opa-kube-mgmt
    spec:
      initContainers:
        - name: initpolicy
          image: openpolicyagent/kube-mgmt:9.3.0
          imagePullPolicy: IfNotPresent
          resources:
            {}
          command:
          - /bin/sh
          - -c
          - |
            tr -dc 'A-F0-9' < /dev/urandom | dd bs=1 count=32 2>/dev/null > /bootstrap/mgmt-token
            TOKEN=`cat /bootstrap/mgmt-token`
            cat > /bootstrap/authz.rego <<EOF
            package system.authz
            import rego.v1
            default allow := false
            # Allow anonymous access to the default policy decision.
            allow if { input.path = [""]; input.method == "POST" }
            allow if { input.path = [""]; input.method == "GET" }
            # This is only used for health check in liveness and readiness probe
            allow if { input.path = ["health"]; input.method == "GET" }
            allow if { input.identity == "$TOKEN" }
            EOF
          volumeMounts:
            - name: bootstrap
              mountPath: /bootstrap
      containers:
        - name: opa
          ports:
          - name: opa
            containerPort: 8181
          image: "openpolicyagent/opa:1.3.0"
          imagePullPolicy: IfNotPresent
          env:
          resources:
            {}
          args:
            - "run"
            - "--server"
            - "--tls-cert-file=/certs/tls.crt"
            - "--tls-private-key-file=/certs/tls.key"
            - "--addr=0.0.0.0:8181"
            - "--log-level=info"
            - "--log-format=json"
            - "--authentication=token"
            - "--authorization=basic"
            - "--ignore=.*"
            - "/bootstrap"
          volumeMounts:
            - name: certs
              readOnly: true
              mountPath: /certs
            - name: bootstrap
              readOnly: true
              mountPath: /bootstrap
          readinessProbe:
            httpGet:
              path: /health
              scheme: HTTPS
              port: opa
            initialDelaySeconds: 5
            periodSeconds: 10
          livenessProbe:
            httpGet:
              path: /health
              scheme: HTTPS
              port: opa
            initialDelaySeconds: 10
            periodSeconds: 15
        - name: mgmt
          image: openpolicyagent/kube-mgmt:9.3.0
          imagePullPolicy: IfNotPresent
          startupProbe:

            failureThreshold: 5
            httpGet:
              path: /health
              port: 8181
              scheme: HTTPS
            initialDelaySeconds: 20
            successThreshold: 1
            timeoutSeconds: 10
          env:
          resources:
            
            {}
          args:
            - --opa-auth-token-file=/bootstrap/mgmt-token
            - --opa-url=https://127.0.0.1:8181/v1
            - --opa-allow-insecure
            - "--namespaces=default"
            - "--enable-data=true"
            - "--enable-policies=true"

            - "--replicate-path=kubernetes"
            - "--replicate-ignore-namespaces="
          volumeMounts:
            - name: bootstrap
              readOnly: true
              mountPath: /bootstrap
      serviceAccountName: open-policy-agent-0-opa-kube-mgmt
      volumes:
        - name: certs
          secret:
            secretName: open-policy-agent-0-opa-kube-mgmt-cert
        - name: bootstrap
          emptyDir: {}
      affinity:
        {}
      nodeSelector:
        kubernetes.io/arch: amd64
      tolerations:
        []
      topologySpreadConstraints:
        []
