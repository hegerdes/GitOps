---
# Source: opa-kube-mgmt/templates/serviceaccount.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: open-policy-agent-0-opa-kube-mgmt
  labels:
    app: open-policy-agent-0-opa-kube-mgmt
    chart: opa-kube-mgmt-9.3.0
    release: "open-policy-agent-0"
    heritage: "Helm"
---
# Source: opa-kube-mgmt/templates/webhookconfiguration.yaml
apiVersion: v1
kind: Secret
metadata:
  name: open-policy-agent-0-opa-kube-mgmt-cert
  labels:
    app: open-policy-agent-0-opa-kube-mgmt
    chart: "opa-kube-mgmt-9.3.0"
    release: "open-policy-agent-0"
    heritage: "Helm"
type: Opaque
data:
  tls.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURlakNDQW1LZ0F3SUJBZ0lSQVA3SlB6RGFzQThDelY1ZXhodHNhb1F3RFFZSktvWklodmNOQVFFTEJRQXcKR3pFWk1CY0dBMVVFQXhNUWIzQmhMV0ZrYldsemMybHZiaTFqWVRBZUZ3MHlOakF4TWpReE9EUTBNVGRhRncwegpOakF4TWpJeE9EUTBNVGRhTURneE5qQTBCZ05WQkFNVExXOXdaVzR0Y0c5c2FXTjVMV0ZuWlc1MExUQXRiM0JoCkxXdDFZbVV0YldkdGRDNWtaV1poZFd4MExuTjJZekNDQVNJd0RRWUpLb1pJaHZjTkFRRUJCUUFEZ2dFUEFEQ0MKQVFvQ2dnRUJBTDIvbldoR3pRUEZGeVpRaGVjR0JmQjdlYzhiT2g1VFBYbVJPRnRNcmJQV21md20zZFZyT1Y4NQpQSWQzZ2tOQmdXVmVveGVkL3IwYUJ6azZqRWJhL3pBZnlXWlJSY3E0QTRvQUZ3dWRGT05BV0t0RjNyOU9lTUNuCmg5VWNiYyt6ejBiOTdXeWZPNUJ2ajl2eG1Jc0hYOTVPUVR1Wmc2M1FsMmo3U2RlMUJNZGF1TTdGN0t0R1QvYmIKb1ZhS3JtbUtlWHY0ZHVtbHhsNkpDRzVUTHJLMkl6MmZ0UTNQMXFqKzJsN0NVN0twMlhRRlgwdDRQQ3VjMFFjUwo1K21NdEw4cFJmRzVvKzBCWEFVYW5VVVVRcU5KMnRUUmV1M2tqVStLMnRhRjNHTHdNS2tEZEZHRS9xQTBkTXh4CldOR0JTdmNmbFpQUEUrSG9SY0o4ZGxpamtaa3p2bXNDQXdFQUFhT0JtekNCbURBT0JnTlZIUThCQWY4RUJBTUMKQmFBd0hRWURWUjBsQkJZd0ZBWUlLd1lCQlFVSEF3RUdDQ3NHQVFVRkJ3TUNNQXdHQTFVZEV3RUIvd1FDTUFBdwpId1lEVlIwakJCZ3dGb0FVVTg2R0FJZUQwRU9WaS92bWR6NnMwMmh6NlYwd09BWURWUjBSQkRFd0w0SXRiM0JsCmJpMXdiMnhwWTNrdFlXZGxiblF0TUMxdmNHRXRhM1ZpWlMxdFoyMTBMbVJsWm1GMWJIUXVjM1pqTUEwR0NTcUcKU0liM0RRRUJDd1VBQTRJQkFRQUY4c1dGNU5rZ3prdWhuMzQzSjg0cUV1QmNaUldDSnFvU2d2MWdjS2dFeGg3SgpFd0U1bkJIaHowT2JRN25sb1NFMU9lZTBXVUpWc2JHS2xBMVgwZVFtdFhNaHFpQXJmU0ozc2NNRXhvaEdNOVE3ClV0YXA0UHJGQUtZMWhPdzhacE0xSTJEMzMrb3dRK2ZLT0x6b0t2NkdzcEk0QS9CbUlNWDAwNGI4b2NDUXpHSmQKYml5MVI1Mml5SDI3Q0NheERYcmZPdEI1NVM0QjdiZjIrTTlqVTdsYnAxZEpxclQ0RWZYNUdzWVZISEtUV3pjMQpCSlIwU0VDVHlQYVJocTRXQ3hEeWwzSGErM2FSUk13UVZWYnFVYnlOeThUeUc1cjBrWTFNenJhSVBWdW0rYlFHCmk2V3hwa0tKMk5rTFpqMHpCQTFSVWcxZ1RYOXc3Tk1lOWppbFZrVlIKLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=
  tls.key: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFb3dJQkFBS0NBUUVBdmIrZGFFYk5BOFVYSmxDRjV3WUY4SHQ1enhzNkhsTTllWkU0VzB5dHM5YVovQ2JkCjFXczVYems4aDNlQ1EwR0JaVjZqRjUzK3ZSb0hPVHFNUnRyL01CL0pabEZGeXJnRGlnQVhDNTBVNDBCWXEwWGUKdjA1NHdLZUgxUnh0ejdQUFJ2M3RiSjg3a0crUDIvR1lpd2RmM2s1Qk81bURyZENYYVB0SjE3VUV4MXE0enNYcwpxMFpQOXR1aFZvcXVhWXA1ZS9oMjZhWEdYb2tJYmxNdXNyWWpQWisxRGMvV3FQN2FYc0pUc3FuWmRBVmZTM2c4Cks1elJCeExuNll5MHZ5bEY4Ym1qN1FGY0JScWRSUlJDbzBuYTFORjY3ZVNOVDRyYTFvWGNZdkF3cVFOMFVZVCsKb0RSMHpIRlkwWUZLOXgrVms4OFQ0ZWhGd254MldLT1JtVE8rYXdJREFRQUJBb0lCQUN2M3hLK3ZDRDZCWXZYYgozc3REbUFpN2MrUkx1TkhpRS9LaGRkK2lDdllMR2k5VmlqMnoxTjE5MDhySUpJVVZIcml3anpZZnhERnBZSmNnCk8vVUhOZTZlenZwSWh0V01nalZ1QStrTEF4WU5pUDVXK0dCMy9IOFgwdC9NOEowYVcwTmwvNmdWMWFXSVZGdHcKeGhvaElWUFA2a20zTHM0TjhhZS80c0o3RFpwcnd2SU5JTkEwcGdqQ2czamNiY0tLdnlJZ2RpcWk3UlNlV25oNgp5K1JzaUl3azQ0UXNqNUJZWG9waEdONWtINVc1NlNSTmM0dUNWaEtWbHhGYWVEM2lpb1NIMUNPNUw5ZzQ2YlJXCkNBa2s4MHpYMGlLY2VTMVZEQnhTY0xtU2RvVkt4M1l0TWc5Q3ptN1NCcWs1ZlVBSzlSTEwvMVhVUGZiSXZNVzYKWUx1NVRtRUNnWUVBNkdlVHFjQWlCcnB6ZitrMmZQRFV6cmdtclhmUSttRm9LVWw0QjkyWUF0VGorcmxDVkJHWApUK1RiTExsMEJpZTRtcW5pM05RMGlCRm1PR1RVVTVHN25SYmxaRE5RcHFaSDVZNWNzQmhIYjgwaG95WGI2L05UCjdKN2NURHl6My81ZlBpSk9xeUlYbXJLMFE2QkZZMjREd1p2VWlRZDZ3OWZWempEcE5XMGxPVmtDZ1lFQTBRTmQKTzlsNzZITU15c0Z6UEFxd0xVdXk1aFdJdlc1MGQ1Y2hJMmdiNnpIcit1a3JHWVQyblJNTE5OOXZZTFBRY2YzUgpoZVUvM2hFWE8xSGFDTVVpUS9YdUtpZTI2MXZHcGhmamtJaXpQMFZta0NteVVxTnEzSWNOY1pwbC9GQ3F6cUQwCjJOek41VjRqbnFEYzJtVC9CQytGL0l0RmZhOVZndjQ5SWo5ZitXTUNnWUVBdlBYcVkrenFQWm8vNnRLT0VRd24KbTJTelhmdTdtTGkyWGt0MElzRVRwY20vQzg2eGxYVXdHQysxM1NsMG9zU05Ib1BmQnpvcTlDOWhjNXpYM3BMeApmb3B0UFFsVUhBdTdEWFN3L0NUaGdJL0ROOG5DaEpnMXRvQjhFaWlSQUNEdEE3SVZVS1BKbVdpUGxTU3RCbWtlCitMNWhFb0ZZV2dBVndTNlhqMjhOQXhFQ2dZQUd4dklsOTZaUjRqRWUvZWpMb0prWHp1V05HbE9sdU1nai9JMkIKaFdXcVdhTUtMcmRNQzRpbmpTK0cxbHZaS2R0dlpzaDlhL0tITTh5cUNyeGtIbWcvQmVGa0VvZVcyQkgzM3J4dApPbEY5a3JXQnBTaDREMzV1aWg2QWVYNG5FVUtJa3FWOXhxTVNkZHYzejhWNWUxN2RkdUVFVUV1L2lJamdSM2daCi9TNFNld0tCZ0VYOUtkd05NQ3ZLQ2psMnRSaW9GdWxtVUJ3d09iNnJJWVFucWJMTVpLOTlrcURybm9RMitIa1kKb25VZ3NxeTZweXpJYkJCK3ZURzg2UDFNaVc5dHVNSHd6RjlycUxiU0hwOXQrSTNZM1FJek9ZNVdnbEZqZk1OUApKYmdQeTJTMUFMcDBpSHRkbzUxRFhVVjJYMi9PZ1BtRUpDUVVnQk5SZHgxTzlvTDNKWVIyCi0tLS0tRU5EIFJTQSBQUklWQVRFIEtFWS0tLS0tCg==
---
# Source: opa-kube-mgmt/templates/rbac-mgmt.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  labels:
    app: opa-kube-mgmt
    chart: opa-kube-mgmt-9.3.0
    release: open-policy-agent-0
    component: mgmt
  name: open-policy-agent-0-opa-kube-mgmt-mgmt
  namespace: default
rules:
  - apiGroups: [""]
    resources: ["configmaps"]
    verbs: ["get", "list", "watch", "update", "patch"]
---
# Source: opa-kube-mgmt/templates/rbac-mgmt.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  labels:
    app: opa-kube-mgmt
    chart: opa-kube-mgmt-9.3.0
    release: open-policy-agent-0
    component: mgmt
  name: open-policy-agent-0-opa-kube-mgmt-mgmt
  namespace: default
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: open-policy-agent-0-opa-kube-mgmt-mgmt
subjects:
  - kind: ServiceAccount
    name: open-policy-agent-0-opa-kube-mgmt
    namespace: default
---
# Source: opa-kube-mgmt/templates/service.yaml
kind: Service
apiVersion: v1
metadata:
  name: open-policy-agent-0-opa-kube-mgmt
  labels:
    app: open-policy-agent-0-opa-kube-mgmt
    chart: "opa-kube-mgmt-9.3.0"
    release: "open-policy-agent-0"
    heritage: "Helm"
spec:
  selector:
    app: open-policy-agent-0-opa-kube-mgmt
  ports:
  - name: opa
    port: 8181
    targetPort: opa
---
# Source: opa-kube-mgmt/templates/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: open-policy-agent-0-opa-kube-mgmt
  labels:
    app: open-policy-agent-0-opa-kube-mgmt
    chart: "opa-kube-mgmt-9.3.0"
    release: "open-policy-agent-0"
    heritage: "Helm"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: open-policy-agent-0-opa-kube-mgmt
  template:
    metadata:
      annotations:
      labels:
        app: open-policy-agent-0-opa-kube-mgmt
      name: open-policy-agent-0-opa-kube-mgmt
    spec:
      initContainers:
        - name: initpolicy
          image: openpolicyagent/kube-mgmt:9.3.0
          imagePullPolicy: IfNotPresent
          resources:
            {}
          command:
          - /bin/sh
          - -c
          - |
            tr -dc 'A-F0-9' < /dev/urandom | dd bs=1 count=32 2>/dev/null > /bootstrap/mgmt-token
            TOKEN=`cat /bootstrap/mgmt-token`
            cat > /bootstrap/authz.rego <<EOF
            package system.authz
            import rego.v1
            default allow := false
            # Allow anonymous access to the default policy decision.
            allow if { input.path = [""]; input.method == "POST" }
            allow if { input.path = [""]; input.method == "GET" }
            # This is only used for health check in liveness and readiness probe
            allow if { input.path = ["health"]; input.method == "GET" }
            allow if { input.identity == "$TOKEN" }
            EOF
          volumeMounts:
            - name: bootstrap
              mountPath: /bootstrap
      containers:
        - name: opa
          ports:
          - name: opa
            containerPort: 8181
          image: "openpolicyagent/opa:1.3.0"
          imagePullPolicy: IfNotPresent
          env:
          resources:
            {}
          args:
            - "run"
            - "--server"
            - "--tls-cert-file=/certs/tls.crt"
            - "--tls-private-key-file=/certs/tls.key"
            - "--addr=0.0.0.0:8181"
            - "--log-level=info"
            - "--log-format=json"
            - "--authentication=token"
            - "--authorization=basic"
            - "--ignore=.*"
            - "/bootstrap"
          volumeMounts:
            - name: certs
              readOnly: true
              mountPath: /certs
            - name: bootstrap
              readOnly: true
              mountPath: /bootstrap
          readinessProbe:
            httpGet:
              path: /health
              scheme: HTTPS
              port: opa
            initialDelaySeconds: 5
            periodSeconds: 10
          livenessProbe:
            httpGet:
              path: /health
              scheme: HTTPS
              port: opa
            initialDelaySeconds: 10
            periodSeconds: 15
        - name: mgmt
          image: openpolicyagent/kube-mgmt:9.3.0
          imagePullPolicy: IfNotPresent
          startupProbe:

            failureThreshold: 5
            httpGet:
              path: /health
              port: 8181
              scheme: HTTPS
            initialDelaySeconds: 20
            successThreshold: 1
            timeoutSeconds: 10
          env:
          resources:
            
            {}
          args:
            - --opa-auth-token-file=/bootstrap/mgmt-token
            - --opa-url=https://127.0.0.1:8181/v1
            - --opa-allow-insecure
            - "--namespaces=default"
            - "--enable-data=true"
            - "--enable-policies=true"

            - "--replicate-path=kubernetes"
            - "--replicate-ignore-namespaces="
          volumeMounts:
            - name: bootstrap
              readOnly: true
              mountPath: /bootstrap
      serviceAccountName: open-policy-agent-0-opa-kube-mgmt
      volumes:
        - name: certs
          secret:
            secretName: open-policy-agent-0-opa-kube-mgmt-cert
        - name: bootstrap
          emptyDir: {}
      affinity:
        {}
      nodeSelector:
        kubernetes.io/arch: amd64
      tolerations:
        []
      topologySpreadConstraints:
        []
